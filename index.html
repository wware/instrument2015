<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>The Tooba: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">The Tooba
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The Tooba Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Tooba is an electronic musical instrument built into a piece of PVC tubing (hence the name). It borrows principles from the Moog-style analog music synthesizers of past decades.</p>
<p><a href="https://www.youtube.com/watch?v=QGhZ0tecp60">![Video demo of the instrument](http://img.youtube.com/vi/QGhZ0tecp60/0.jpg)</a></p>
<p>Way back when, one of my friends in high school was a guy named <a href="http://www.matrixsynth.com/2010/08/rip-david-hillel-wilson-curator-of-new.html">Dave Wilson</a> whose father got him into 1970s-era Moog-style analog electronic music synthesizers. Dave created a museum of historical synthesizers in his home in Nashua, New Hampshire. Throughout our high school and college years, we exchanged ideas and circuits and bits of lore for various synthesizer hacks.</p>
<p>Music synthesizers of that era were actually special-purpose <a href="https://en.wikipedia.org/wiki/Analog_computer">analog computers</a>, performing arithmetic operations with <a href="https://courses.engr.illinois.edu/ece486/labs/lab1/analog_computer_manual.pdf">integrators, summers, and other such circuits</a>. These computations can be performed digitally by a microprocessor or special-purpose digital circuit (e.g. FPGA). So Dave and I both at various points and in various contexts wrote code to do that.</p>
<p>Sound generation in the Tooba (and keyboard scanning and voice assignment) is done in <a href="https://github.com/wware/instrument2015/blob/master/nextstage/teensy/teensy.ino">C++</a> running on a 32-bit ARM microcontroller.</p>
<h2>Status, plans, etc </h2>
<p>The first PVC prototype, the one shown at Providence on Aug 8th 2015, did all sound generation in the interrupt handler. More recently, the interrupt handler only transfers audio samples from a queue to the microcontroller's on-chip 12-bit DAC, and sound generation occurs in the <a class="el" href="teensy_8ino.html#a0b33edabd7f1c4e4a0bf32c67269be2f">loop()</a> function.</p>
<ul>
<li>Doxygen stuff is now <a href="http://wware.github.io/instrument2015/">online</a>.</li>
<li>Removing sound generation from the interrupt handler and moving it into the main loop solved a LOT of problems, and now I can run the interrupt at 40 kHz. But I am still hearing some aliasing, so I'll need a lowpass filter after the DAC. Use this <a href="http://www.digikey.com/product-detail/en/LT1677CN8%23PBF/LT1677CN8%23PBF-ND/962980">rail-to-rail op amp</a>.</li>
<li><a class="el" href="classADSR.html">ADSR</a> and other slow-moving things should perform real calculations at only around 50 Hz, not 40 or 50 kHz. In between calculations they should use linear interpolation. Four billion divided by 50K is 80K, so itâ€™s fine to use 16 fraction bits to interpolate. This will significantly speed things up.</li>
<li>Never copy or move blocks of data. Move pointers instead. The persistence data for a voice should live in one place and never move.</li>
<li>The next step right now is to take the code in the <a class="el" href="classVoice.html">Voice</a> class and split it into VCO, VCA and <a class="el" href="classADSR.html">ADSR</a> classes. Then add a Noise class, a Scaler class, a Summer class, and a VCF class. The audio outputs of all these should be 24-bit signed integers in the range from -0x80_0000 to 0x7F_FFFF. Use asserts to make sure they never go outside that range.</li>
<li>Set up a <a href="https://en.wikipedia.org/wiki/Monkey_test">monkey test framework</a> that virtually pounds on the keyboard, and detects overflows, underruns, etc.<ul>
<li>A <a href="http://swig.org/">SWIG wrapper</a> will be very helpful with this.</li>
</ul>
</li>
</ul>
<h2>Teensy 3.1 info </h2>
<ul>
<li><a href="http://www.freescale.com/webapp/sps/site/prod_summary.jsp?code=K20_50">The Freescale Semiconductor web page</a> for the MK20DX256VLH7 processor used in the Teensy 3.1.</li>
<li><a href="https://www.pjrc.com/teensy/K20P64M72SF1RM.pdf">The datasheet</a> that talks about GPIO programming starting on page 1331.</li>
<li><a href="https://www.pjrc.com/teensy/schematic.html">The Teensy 3.1 schematic</a>. PTB17 is the GPIO that I want to read. The Port B input register is at 0x400FF050. There is no MMU so no need for any mmap craziness.</li>
<li><a href="https://forum.pjrc.com/threads/25317-Assembly-coding-for-Teensy3-1">Here</a> is a great discussion of embedding assembly in C code. Also see <a href="http://www.ethernut.de/en/documents/arm-inline-asm.html">http://www.ethernut.de/en/documents/arm-inline-asm.html</a>.</li>
<li><a href="http://www.keil.com/dd/docs/arm/freescale/kinetis/mk20d7.h">A C header file</a> for registers in the MK20DX.</li>
<li><a href="http://www.peter-cockerell.net/aalp/html/frames.html">Some nice info</a> on ARM assembly language.</li>
</ul>
<h2>Earlier prototype </h2>
<p>I want to read the GPIO in assembly to accurately measure the period of the oscillator. This code ran on the June prototype and measured the capacitance of the touch sensitive keyboard. The capacitance was used in the RC time constant of a free-running oscillator and the idea here is to get a measurement roughly proportional to the period.</p>
<ol type="1">
<li>Set counter to zero.</li>
<li>If input is LOW, go to step 7.</li>
<li>Wait for a falling edge. Proceed when input is LOW.</li>
<li>Increment counter while waiting for rising edge. Proceed when input is HIGH.</li>
<li>Increment counter while waiting for falling edge. Proceed when input is LOW.</li>
<li>Go to step 10.</li>
<li>Wait for a rising edge. Proceed when input is HIGH.</li>
<li>Increment counter while waiting for falling edge. Proceed when input is LOW.</li>
<li>Increment counter while waiting for rising edge. Proceed when input is HIGH.</li>
<li>Return counter.</li>
</ol>
<p>So that piece is assembly, and then in C you choose a touch contact and call that function. That should ensure that you read the keyboard about as fast as it can be read. The code for this is buried in <a href="https://github.com/wware/instrument2015/blob/master/sandbox/prototype1/prototype1.ino#L7">the sandbox directory</a>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;static int measurePeriod(void)</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;{</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    // Step 1, set up registers</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    int count = 0, x = 0, mask = 1 &lt;&lt; 17, addr = 0x400ff050;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;#   define READ_INPUT  &quot;ldr %1, [%3]\n&quot;     &quot;ands %1, %1, %2\n&quot;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;#   define INC_COUNT   &quot;add %0, %0, #1\n&quot;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    asm volatile(</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        // Step 2, if input is low go to step 7</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        READ_INPUT</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        &quot;beq step7&quot;                             &quot;\n&quot;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        // Step 3, wait for falling edge</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        &quot;step3:&quot;                                &quot;\n&quot;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        ... lots more code ...</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        &quot;step10:&quot;                               &quot;\n&quot;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        : &quot;+r&quot; (count), &quot;+r&quot; (x), &quot;+r&quot; (mask), &quot;+r&quot; (addr)</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    );</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    return count;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;}</div>
</div><!-- fragment --><p>This works well in both the <a href="https://www.pjrc.com/teensy/teensyduino.html">Arduino/Teensy IDE</a> and in the <a href="http://assembly.ynh.io/">online ARM C++ compiler</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 15 2015 21:01:51 for The Tooba by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
